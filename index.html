<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Video Call</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #4285F4;
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            margin: 0;
        }
        
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .video-item {
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        video {
            width: 100%;
            max-width: 500px;
            display: block;
            background-color: #222;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3367d6;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        button.end-call {
            background-color: #ea4335;
        }
        
        button.end-call:hover {
            background-color: #d33426;
        }
        
        .room-info {
            text-align: center;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        #roomId {
            font-weight: bold;
            font-size: 18px;
            color: #4285F4;
        }
        
        .connection-status {
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .status-connecting {
            color: #fbbc05;
        }
        
        .status-connected {
            color: #34a853;
        }
        
        .status-disconnected {
            color: #ea4335;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 8px;
            color: white;
            background-color: #4285F4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 100;
            max-width: 300px;
        }
        
        .notification.error {
            background-color: #ea4335;
        }
        
        .notification.success {
            background-color: #34a853;
        }
        
        #peerIdInput {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Simple Video Call</h1>
        </header>
        
        <div class="room-info">
            <p>Your Room ID: <span id="roomId">Generating...</span></p>
            <p>Share this ID with others to connect</p>
            <div>
                <input type="text" id="peerIdInput" placeholder="Enter peer's room ID">
                <button id="connectBtn">Connect</button>
            </div>
        </div>
        
        <div class="connection-status">
            <p id="connectionStatus">Initializing...</p>
        </div>
        
        <div class="video-container">
            <div class="video-item">
                <video id="localVideo" autoplay muted playsinline></video>
                <p style="text-align: center; padding: 10px;">You</p>
            </div>
            <div class="video-item">
                <video id="remoteVideo" autoplay playsinline></video>
                <p style="text-align: center; padding: 10px;">Remote User</p>
            </div>
        </div>
        
        <div class="controls">
            <button id="muteBtn" disabled>Mute Audio</button>
            <button id="videoBtn" disabled>Stop Video</button>
            <button id="screenShareBtn" disabled>Share Screen</button>
            <button id="endCallBtn" class="end-call" disabled>End Call</button>
        </div>
        
        <footer>
            <p>Simple Video Call App | Built with WebRTC</p>
        </footer>
    </div>
    
    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        let localStream;
        let peer;
        let currentCall;
        let isAudioMuted = false;
        let isVideoOff = false;
        let isScreenSharing = false;
        let originalStream;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;
        
        // DOM elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdElement = document.getElementById('roomId');
        const peerIdInput = document.getElementById('peerIdInput');
        const connectBtn = document.getElementById('connectBtn');
        const muteBtn = document.getElementById('muteBtn');
        const videoBtn = document.getElementById('videoBtn');
        const screenShareBtn = document.getElementById('screenShareBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const notification = document.getElementById('notification');
        
        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Initialize the app
        async function init() {
            try {
                connectionStatus.textContent = 'Requesting camera and microphone access...';
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                }).catch(err => {
                    if (err.name === 'NotAllowedError') {
                        throw new Error('Camera and microphone access denied. Please allow access to use this app.');
                    } else if (err.name === 'NotFoundError') {
                        throw new Error('No camera or microphone found. Please check your device connections.');
                    } else {
                        throw err;
                    }
                });
                
                // Save original stream for toggling screen share
                originalStream = localStream;
                
                // Show local video
                localVideo.srcObject = localStream;
                
                // Enable control buttons once we have media
                muteBtn.disabled = false;
                videoBtn.disabled = false;
                screenShareBtn.disabled = false;
                
                connectionStatus.textContent = 'Initializing connection...';
                
                // Initialize peer connection with more robust error handling
                initializePeerConnection();
                
                // Set up the connect button
                connectBtn.addEventListener('click', connectToPeer);
                
                // Set up control buttons
                muteBtn.addEventListener('click', toggleAudio);
                videoBtn.addEventListener('click', toggleVideo);
                screenShareBtn.addEventListener('click', toggleScreenShare);
                endCallBtn.addEventListener('click', endCall);
                
                showNotification('Video call app initialized successfully', 'success');
                
            } catch (err) {
                console.error('Initialization error:', err);
                connectionStatus.textContent = 'Error: ' + err.message;
                connectionStatus.className = 'status-disconnected';
                showNotification(err.message, 'error');
            }
        }
        
        // Initialize PeerJS connection with error handling
        function initializePeerConnection() {
            try {
                // Close any existing peer connection
                if (peer) {
                    peer.destroy();
                }
                
                // Create new peer connection
                peer = new Peer({
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    },
                    debug: 2
                });
                
                // When peer is open, show the ID
                peer.on('open', (id) => {
                    roomIdElement.textContent = id;
                    connectionStatus.textContent = 'Ready to connect';
                    connectionStatus.className = '';
                    
                    // Reset reconnect attempts on successful connection
                    reconnectAttempts = 0;
                });
                
                // Handle incoming calls
                peer.on('call', (call) => {
                    connectionStatus.textContent = 'Incoming call...';
                    connectionStatus.className = 'status-connecting';
                    showNotification('Incoming call', 'info');
                    
                    // Answer the call
                    call.answer(localStream);
                    currentCall = call;
                    
                    // Enable end call button
                    endCallBtn.disabled = false;
                    
                    // Handle stream event
                    handleCallStream(call);
                });
                
                // Handle disconnections
                peer.on('disconnected', () => {
                    connectionStatus.textContent = 'Connection lost. Attempting to reconnect...';
                    connectionStatus.className = 'status-disconnected';
                    
                    // Try to reconnect
                    setTimeout(() => {
                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            reconnectAttempts++;
                            peer.reconnect();
                        } else {
                            connectionStatus.textContent = 'Could not reconnect after multiple attempts. Please refresh the page.';
                            showNotification('Connection failed. Please refresh the page.', 'error');
                        }
                    }, 2000);
                });
                
                // Handle connection closing
                peer.on('close', () => {
                    connectionStatus.textContent = 'Connection closed';
                    connectionStatus.className = 'status-disconnected';
                    endCallBtn.disabled = true;
                });
                
                // Handle errors
                peer.on('error', (err) => {
                    console.error('Peer connection error:', err);
                    let errorMessage = 'Connection error';
                    
                    // Handle specific error types
                    if (err.type === 'peer-unavailable') {
                        errorMessage = 'Peer not found. Check the ID and try again.';
                    } else if (err.type === 'network') {
                        errorMessage = 'Network error. Please check your connection.';
                    } else if (err.type === 'server-error') {
                        errorMessage = 'Server error. Please try again later.';
                    } else if (err.type === 'browser-incompatible') {
                        errorMessage = 'Your browser may not fully support WebRTC. Try using Chrome or Firefox.';
                    }
                    
                    connectionStatus.textContent = errorMessage;
                    connectionStatus.className = 'status-disconnected';
                    showNotification(errorMessage, 'error');
                    
                    // If we're in a call, end it
                    if (currentCall) {
                        currentCall = null;
                        remoteVideo.srcObject = null;
                        endCallBtn.disabled = true;
                    }
                });
                
            } catch (err) {
                console.error('Error initializing peer connection:', err);
                connectionStatus.textContent = 'Connection initialization failed';
                connectionStatus.className = 'status-disconnected';
                showNotification('Failed to initialize connection', 'error');
            }
        }
        
        // Connect to a peer
        function connectToPeer() {
            const peerId = peerIdInput.value.trim();
            
            if (!peerId) {
                showNotification('Please enter a valid Peer ID', 'error');
                return;
            }
            
            connectionStatus.textContent = 'Connecting...';
            connectionStatus.className = 'status-connecting';
            
            try {
                // Call the peer
                const call = peer.call(peerId, localStream);
                
                if (!call) {
                    throw new Error('Failed to initiate call');
                }
                
                currentCall = call;
                
                // Enable end call button
                endCallBtn.disabled = false;
                
                // Handle stream event
                handleCallStream(call);
                
            } catch (err) {
                console.error('Error connecting to peer:', err);
                connectionStatus.textContent = 'Connection failed';
                connectionStatus.className = 'status-disconnected';
                showNotification('Failed to connect: ' + err.message, 'error');
            }
        }
        
        // Handle call stream
        function handleCallStream(call) {
            // Set timeout for connection
            const connectionTimeout = setTimeout(() => {
                if (!remoteVideo.srcObject) {
                    connectionStatus.textContent = 'Connection timed out';
                    connectionStatus.className = 'status-disconnected';
                    showNotification('Connection timed out. The other user may not be available.', 'error');
                    call.close();
                    currentCall = null;
                    endCallBtn.disabled = true;
                }
            }, 30000);
            
            call.on('stream', (remoteStream) => {
                // Clear timeout as we got the stream
                clearTimeout(connectionTimeout);
                
                // Show remote video
                remoteVideo.srcObject = remoteStream;
                
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-connected';
                showNotification('Call connected successfully', 'success');
            });
            
            call.on('close', () => {
                // Clear timeout if call closes before connection
                clearTimeout(connectionTimeout);
                
                connectionStatus.textContent = 'Call ended';
                connectionStatus.className = 'status-disconnected';
                remoteVideo.srcObject = null;
                currentCall = null;
                endCallBtn.disabled = true;
                showNotification('Call ended', 'info');
            });
            
            call.on('error', (err) => {
                // Clear timeout if error occurs
                clearTimeout(connectionTimeout);
                
                console.error('Call error:', err);
                connectionStatus.textContent = 'Call error: ' + (err.message || 'Unknown error');
                connectionStatus.className = 'status-disconnected';
                remoteVideo.srcObject = null;
                currentCall = null;
                endCallBtn.disabled = true;
                showNotification('Call error: ' + (err.message || 'Unknown error'), 'error');
            });
        }
        
        // Toggle audio
        function toggleAudio() {
            try {
                if (localStream) {
                    const audioTracks = localStream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        isAudioMuted = !isAudioMuted;
                        audioTracks[0].enabled = !isAudioMuted;
                        muteBtn.textContent = isAudioMuted ? 'Unmute Audio' : 'Mute Audio';
                        showNotification(isAudioMuted ? 'Audio muted' : 'Audio unmuted', 'info');
                    } else {
                        showNotification('No audio track found', 'error');
                    }
                }
            } catch (err) {
                console.error('Error toggling audio:', err);
                showNotification('Failed to toggle audio', 'error');
            }
        }
        
        // Toggle video
        function toggleVideo() {
            try {
                if (localStream) {
                    const videoTracks = localStream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        isVideoOff = !isVideoOff;
                        videoTracks[0].enabled = !isVideoOff;
                        videoBtn.textContent = isVideoOff ? 'Start Video' : 'Stop Video';
                        showNotification(isVideoOff ? 'Video stopped' : 'Video started', 'info');
                    } else {
                        showNotification('No video track found', 'error');
                    }
                }
            } catch (err) {
                console.error('Error toggling video:', err);
                showNotification('Failed to toggle video', 'error');
            }
        }
        
        // Toggle screen sharing
        async function toggleScreenShare() {
            try {
                if (isScreenSharing) {
                    // Switch back to camera
                    localStream = originalStream;
                    screenShareBtn.textContent = 'Share Screen';
                    showNotification('Screen sharing stopped', 'info');
                } else {
                    // Switch to screen sharing
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true
                    }).catch(err => {
                        if (err.name === 'NotAllowedError') {
                            throw new Error('Screen sharing permission denied');
                        } else {
                            throw err;
                        }
                    });
                    
                    // Keep audio from original stream if it exists
                    if (originalStream) {
                        const audioTrack = originalStream.getAudioTracks()[0];
                        if (audioTrack) {
                            screenStream.addTrack(audioTrack);
                        }
                    }
                    
                    localStream = screenStream;
                    screenShareBtn.textContent = 'Stop Sharing';
                    showNotification('Screen sharing started', 'success');
                    
                    // Handle the case when user stops sharing via browser UI
                    screenStream.getVideoTracks()[0].onended = () => {
                        if (isScreenSharing) {
                            toggleScreenShare();
                        }
                    };
                }
                
                // Update local video
                localVideo.srcObject = localStream;
                
                // Update the call if in progress
                if (currentCall) {
                    try {
                        // Close current call and create a new one with updated stream
                        const peerId = currentCall.peer;
                        currentCall.close();
                        
                        // Small delay to ensure everything is updated
                        setTimeout(() => {
                            try {
                                const newCall = peer.call(peerId, localStream);
                                if (newCall) {
                                    currentCall = newCall;
                                    handleCallStream(newCall);
                                } else {
                                    throw new Error('Failed to create new call');
                                }
                            } catch (err) {
                                console.error('Error creating new call:', err);
                                connectionStatus.textContent = 'Failed to update call with screen share';
                                connectionStatus.className = 'status-disconnected';
                                showNotification('Failed to update call. Please reconnect.', 'error');
                            }
                        }, 1000);
                    } catch (err) {
                        console.error('Error updating call:', err);
                        showNotification('Failed to update call with screen sharing', 'error');
                    }
                }
                
                isScreenSharing = !isScreenSharing;
                
            } catch (err) {
                console.error('Error sharing screen:', err);
                showNotification('Screen sharing error: ' + err.message, 'error');
            }
        }
        
        // End the call
        function endCall() {
            try {
                if (currentCall) {
                    currentCall.close();
                    currentCall = null;
                    remoteVideo.srcObject = null;
                    connectionStatus.textContent = 'Call ended';
                    connectionStatus.className = 'status-disconnected';
                    endCallBtn.disabled = true;
                    showNotification('Call ended', 'info');
                }
            } catch (err) {
                console.error('Error ending call:', err);
                showNotification('Error ending call', 'error');
                
                // Force cleanup in case of error
                currentCall = null;
                remoteVideo.srcObject = null;
                endCallBtn.disabled = true;
            }
        }
        
        // Handle page unload to clean up connections
        window.addEventListener('beforeunload', () => {
            if (currentCall) {
                currentCall.close();
            }
            if (peer) {
                peer.destroy();
            }
        });
        
        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
